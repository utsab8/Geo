{% extends 'userdashboard/base.html' %}
{% load static %}

{% block title %}Profile - GeoSurvey{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .profile-header-section {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 20px;
    }

    .profile-header-content {
        display: flex;
        align-items: center;
        gap: 30px;
        flex: 1;
    }

    .profile-avatar-section {
        position: relative;
    }

    .profile-avatar-container {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        border: 4px solid #4f46e5;
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
    }

    .profile-avatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .avatar-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: pointer;
    }

    .profile-avatar-container:hover .avatar-overlay {
        opacity: 1;
    }

    .avatar-upload-btn {
        color: white;
        font-size: 24px;
        cursor: pointer;
    }

    .profile-info-section {
        flex: 1;
    }

    .profile-name {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0 0 10px 0;
    }

    .profile-email {
        font-size: 1.1rem;
        color: #6b7280;
        margin: 0 0 20px 0;
    }

    .profile-stats {
        display: flex;
        gap: 20px;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f3f4f6;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        color: #374151;
    }

    .profile-completion-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        min-width: 300px;
    }

    .completion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .completion-header h3 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .verification-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .completion-progress {
        margin-bottom: 15px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #34d399);
        transition: width 0.5s ease;
    }

    .progress-text {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .completion-breakdown {
        margin-bottom: 15px;
    }

    .breakdown-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .completion-tip {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .profile-navigation {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .nav-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #d1d5db;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .nav-dot.active {
        background: #4f46e5;
        transform: scale(1.2);
    }

    .nav-dot:hover {
        background: #6366f1;
        transform: scale(1.1);
    }

    .nav-dot::after {
        content: attr(title);
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .nav-dot:hover::after {
        opacity: 1;
    }

    .profile-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .profile-section-block {
        display: none;
    }

    .profile-section-block.active {
        display: block;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f3f4f6;
    }

    .section-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .save-btn {
        background: #4f46e5;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .save-btn:hover {
        background: #4338ca;
        transform: translateY(-2px);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .overview-card {
        background: #f9fafb;
        padding: 25px;
        border-radius: 15px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .overview-card:hover {
        border-color: #4f46e5;
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.1);
    }

    .card-icon {
        font-size: 2rem;
        color: #4f46e5;
        margin-bottom: 15px;
    }

    .card-content h3 {
        margin: 0 0 10px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
    }

    .card-content p {
        margin: 0;
        color: #6b7280;
        font-weight: 500;
    }

    .activity-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.3s ease;
    }

    .activity-item:hover {
        background: #f9fafb;
    }

    .activity-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e0e7ff;
        border-radius: 50%;
        color: #4f46e5;
    }

    .activity-details {
        flex: 1;
    }

    .activity-text {
        margin: 0 0 5px 0;
        font-weight: 500;
        color: #1f2937;
    }

    .activity-time {
        font-size: 0.9rem;
        color: #6b7280;
    }

    .danger-zone {
        background: #fef2f2;
        border: 2px solid #fecaca;
        border-radius: 15px;
        padding: 25px;
    }

    .danger-zone h3 {
        color: #dc2626;
        margin-bottom: 15px;
    }

    .delete-btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .delete-btn:hover {
        background: #b91c1c;
        transform: translateY(-2px);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }

    .loading-spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .message {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
    }

    .message.success {
        background: #d1fae5;
        color: #065f46;
        border: 2px solid #10b981;
    }

    .message.error {
        background: #fee2e2;
        color: #991b1b;
        border: 2px solid #ef4444;
    }

    @media (max-width: 768px) {
        .profile-header-section {
            flex-direction: column;
        }

        .profile-header-content {
            flex-direction: column;
            text-align: center;
        }

        .profile-stats {
            justify-content: center;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .overview-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Loading State -->
    <div id="loadingState" class="loading">
        <div class="loading-spinner"></div>
        Loading profile data...
    </div>

    <!-- Profile Content -->
    <div id="profileContent" style="display: none;">
        <!-- Profile Header Section -->
        <div class="profile-header-section">
            <div class="profile-header-content">
                <div class="profile-avatar-section">
                    <div class="profile-avatar-container">
                        <img src="" alt="Profile Picture" class="profile-avatar" id="profile-avatar-preview">
                        <div class="avatar-overlay" onclick="document.getElementById('avatar-upload').click()">
                            <label class="avatar-upload-btn">
                                <i class="fas fa-camera"></i>
                            </label>
                        </div>
                    </div>
                    <input type="file" id="avatar-upload" name="avatar" accept="image/*" style="display: none;">
                </div>
                
                <div class="profile-info-section">
                    <h1 class="profile-name" id="profile-name">Loading...</h1>
                    <p class="profile-email" id="profile-email">Loading...</p>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <i class="fas fa-file"></i>
                            <span id="total-files">0</span> Files
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-map"></i>
                            <span id="total-surveys">0</span> Surveys
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Completion Status -->
            <div class="profile-completion-section">
                <div class="completion-header">
                    <h3>Profile Completion</h3>
                    <div class="verification-badge" id="verification-badge" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        Verified Profile
                    </div>
                </div>
                <div class="completion-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="progress-text" id="progress-text">0% Complete</span>
                </div>
                <div class="completion-breakdown">
                    <div class="breakdown-item">
                        <span class="breakdown-label">Personal Info:</span>
                        <span class="breakdown-value" id="personal-completion">0%</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Social Links:</span>
                        <span class="breakdown-value" id="social-completion">0%</span>
                    </div>
                </div>
                <div class="completion-tip" id="completion-tip" style="display: none;">
                    <i class="fas fa-lightbulb"></i>
                    <span id="completion-tip-text">Complete your profile information</span>
                </div>
            </div>
        </div>

        <!-- Profile Navigation -->
        <div class="profile-navigation">
            <div class="nav-dot active" data-section="profile-overview" title="Overview"></div>
            <div class="nav-dot" data-section="profile-details" title="Personal Info"></div>
            <div class="nav-dot" data-section="social-links" title="Social Links"></div>
            <div class="nav-dot" data-section="account-settings" title="Settings"></div>
            <div class="nav-dot" data-section="password-section" title="Security"></div>
            <div class="nav-dot" data-section="activity-section" title="Activity"></div>
            <div class="nav-dot" data-section="danger-zone" title="Danger Zone"></div>
        </div>

        <!-- Profile Content -->
        <div class="profile-content">
            <!-- Overview Section -->
            <section id="profile-overview" class="profile-section-block active">
                <div class="section-header">
                    <h2><i class="fas fa-user-circle"></i> Profile Overview</h2>
                </div>
                <div class="overview-grid">
                    <div class="overview-card">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-content">
                            <h3>Account Status</h3>
                            <p id="account-status">Loading...</p>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="card-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="card-content">
                            <h3>Member Since</h3>
                            <p id="member-since">Loading...</p>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="card-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                            <h3>Last Login</h3>
                            <p id="last-login">Loading...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Personal Information Section -->
            <section id="profile-details" class="profile-section-block">
                <div class="section-header">
                    <h2><i class="fas fa-user"></i> Personal Information</h2>
                    <button type="button" class="save-btn" onclick="saveProfile()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                <form id="profile-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="full_name">Full Name</label>
                            <input type="text" id="full_name" name="full_name" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label for="phone_number">Phone Number</label>
                            <input type="tel" id="phone_number" name="phone_number" placeholder="Enter your phone number">
                        </div>
                        <div class="form-group">
                            <label for="date_of_birth">Date of Birth</label>
                            <input type="date" id="date_of_birth" name="date_of_birth">
                        </div>
                        <div class="form-group">
                            <label for="address">Address</label>
                            <input type="text" id="address" name="address" placeholder="Enter your address">
                        </div>
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" placeholder="Enter your city">
                        </div>
                        <div class="form-group">
                            <label for="state">State/Province</label>
                            <input type="text" id="state" name="state" placeholder="Enter your state">
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" name="country" placeholder="Enter your country">
                        </div>
                        <div class="form-group">
                            <label for="postal_code">Postal Code</label>
                            <input type="text" id="postal_code" name="postal_code" placeholder="Enter your postal code">
                        </div>
                    </div>
                </form>
            </section>

            <!-- Social Links Section -->
            <section id="social-links" class="profile-section-block">
                <div class="section-header">
                    <h2><i class="fas fa-share-alt"></i> Social Media Links</h2>
                    <button type="button" class="save-btn" onclick="saveSocial()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                <form id="social-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="github">GitHub</label>
                            <input type="url" id="github" name="github" placeholder="https://github.com/username">
                        </div>
                        <div class="form-group">
                            <label for="linkedin">LinkedIn</label>
                            <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/username">
                        </div>
                        <div class="form-group">
                            <label for="facebook">Facebook</label>
                            <input type="url" id="facebook" name="facebook" placeholder="https://facebook.com/username">
                        </div>
                    </div>
                </form>
            </section>

            <!-- Account Settings Section -->
            <section id="account-settings" class="profile-section-block">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Account Settings</h2>
                    <button type="button" class="save-btn" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="email_notifications" name="email_notifications">
                            Email Notifications
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="push_notifications" name="push_notifications">
                            Push Notifications
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="two_factor_auth" name="two_factor_auth">
                            Two-Factor Authentication
                        </label>
                    </div>
                </div>
            </section>

            <!-- Password Section -->
            <section id="password-section" class="profile-section-block">
                <div class="section-header">
                    <h2><i class="fas fa-lock"></i> Change Password</h2>
                    <button type="button" class="save-btn" onclick="changePassword()">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
                <form id="password-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="current_password">Current Password</label>
                            <input type="password" id="current_password" name="current_password" placeholder="Enter current password">
                        </div>
                        <div class="form-group">
                            <label for="new_password">New Password</label>
                            <input type="password" id="new_password" name="new_password" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label for="confirm_password">Confirm New Password</label>
                            <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm new password">
                        </div>
                    </div>
                </form>
            </section>

            <!-- Activity Section -->
            <section id="activity-section" class="profile-section-block">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Recent Activity</h2>
                </div>
                <div class="activity-list" id="activity-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading activities...
                    </div>
                </div>
            </section>

            <!-- Danger Zone Section -->
            <section id="danger-zone" class="profile-section-block">
                <div class="section-header">
                    <h2><i class="fas fa-exclamation-triangle"></i> Danger Zone</h2>
                </div>
                <div class="danger-zone">
                    <h3>Delete Account</h3>
                    <p>Once you delete your account, there is no going back. Please be certain.</p>
                    <form id="delete-account-form">
                        <div class="form-group">
                            <label for="delete_password">Enter your password to confirm</label>
                            <input type="password" id="delete_password" name="password" placeholder="Enter your password">
                        </div>
                        <button type="button" class="delete-btn" onclick="deleteAccount()">
                            <i class="fas fa-trash"></i> Delete Account
                        </button>
                    </form>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let profileData = {};
    let currentSection = 'profile-overview';

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        loadProfileData();
        setupEventListeners();
    });

    // Load profile data from API
    function loadProfileData() {
        showLoading();
        
        fetch('{% url "profile_api" %}')
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    profileData = data;
                    updateProfileUI(data);
                } else {
                    showError(data.error || 'Failed to load profile data');
                }
            })
            .catch(error => {
                hideLoading();
                showError('Failed to load profile data: ' + error.message);
            });
    }

    // Update profile UI with data
    function updateProfileUI(data) {
        const user = data.user;
        
        // Update header information
        document.getElementById('profile-name').textContent = user.full_name || user.email;
        document.getElementById('profile-email').textContent = user.email;
        document.getElementById('total-files').textContent = data.statistics.total_files;
        document.getElementById('total-surveys').textContent = data.statistics.total_surveys;
        
        // Update avatar
        const avatarPreview = document.getElementById('profile-avatar-preview');
        if (user.avatar_url) {
            avatarPreview.src = user.avatar_url;
        } else {
            avatarPreview.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iNjAiIGZpbGw9IiM2QjcyOEIiLz4KPGNpcmNsZSBjeD0iNjAiIGN5PSI0NSIgcj0iMjAiIGZpbGw9IiNEOUQ5RDkiLz4KPHBhdGggZD0iTTIwIDEwNUMyMCA5NS4wNTc2IDI4LjA1NzYgODcgMzggODdIODJDNzEuOTQyNCA4NyA2NCA5NS4wNTc2IDY0IDEwNUg2NEM2NCA5NS4wNTc2IDU1Ljk0MjQgODcgNDUgODdIMzhDMjguMDU3NiA4NyAyMCA5NS4wNTc2IDIwIDEwNVoiIGZpbGw9IiNEOUQ5RDkiLz4KPC9zdmc+Cg==';
        }
        
        // Update completion status
        updateCompletionStatus(data.completion);
        
        // Update overview section
        updateOverviewSection(user);
        
        // Update form fields
        updateFormFields(user);
        
        // Update activities
        updateActivities(data.recent_activities);
        
        // Show profile content
        document.getElementById('profileContent').style.display = 'block';
    }

    // Update completion status
    function updateCompletionStatus(completion) {
        document.getElementById('progress-fill').style.width = completion.profile_completion + '%';
        document.getElementById('progress-text').textContent = completion.profile_completion + '% Complete';
        document.getElementById('personal-completion').textContent = completion.personal_completion + '%';
        document.getElementById('social-completion').textContent = completion.social_completion + '%';
        
        if (completion.is_verified) {
            document.getElementById('verification-badge').style.display = 'flex';
        }
        
        // Show completion tip if not 100%
        if (completion.profile_completion < 100) {
            const tipElement = document.getElementById('completion-tip');
            const tipText = document.getElementById('completion-tip-text');
            
            if (completion.personal_completion < 100) {
                tipText.textContent = 'Complete your personal information to reach 80%';
            } else if (completion.social_completion < 100) {
                tipText.textContent = 'Add your social links to reach 100% and get verified';
            }
            
            tipElement.style.display = 'flex';
        }
    }

    // Update overview section
    function updateOverviewSection(user) {
        document.getElementById('account-status').textContent = profileData.completion.is_verified ? 'Verified Account' : 'Basic Account';
        
        const memberSince = new Date(user.date_joined);
        document.getElementById('member-since').textContent = memberSince.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        
        if (user.last_login) {
            const lastLogin = new Date(user.last_login);
            document.getElementById('last-login').textContent = lastLogin.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } else {
            document.getElementById('last-login').textContent = 'Never';
        }
    }

    // Update form fields
    function updateFormFields(user) {
        // Personal information
        document.getElementById('full_name').value = user.full_name || '';
        document.getElementById('phone_number').value = user.phone_number || '';
        document.getElementById('date_of_birth').value = user.date_of_birth || '';
        document.getElementById('address').value = user.address || '';
        document.getElementById('city').value = user.city || '';
        document.getElementById('state').value = user.state || '';
        document.getElementById('country').value = user.country || '';
        document.getElementById('postal_code').value = user.postal_code || '';
        
        // Social links
        document.getElementById('github').value = user.github || '';
        document.getElementById('linkedin').value = user.linkedin || '';
        document.getElementById('facebook').value = user.facebook || '';
        
        // Settings
        const preferences = profileData.user_preferences;
        document.getElementById('email_notifications').checked = preferences.email_notifications;
        document.getElementById('push_notifications').checked = preferences.push_notifications;
        document.getElementById('two_factor_auth').checked = preferences.two_factor_auth;
    }

    // Update activities
    function updateActivities(activities) {
        const activityList = document.getElementById('activity-list');
        
        if (activities.length === 0) {
            activityList.innerHTML = '<p style="text-align: center; color: #6b7280;">No recent activities</p>';
            return;
        }
        
        let activitiesHTML = '';
        activities.forEach(activity => {
            const timestamp = new Date(activity.timestamp);
            activitiesHTML += `
                <div class="activity-item">
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-details">
                        <p class="activity-text">${activity.description}</p>
                        <span class="activity-time">${timestamp.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                </div>
            `;
        });
        
        activityList.innerHTML = activitiesHTML;
    }

    // Setup event listeners
    function setupEventListeners() {
        // Navigation dots
        document.querySelectorAll('.nav-dot').forEach(dot => {
            dot.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                showSection(section);
            });
        });
        
        // Avatar upload
        document.getElementById('avatar-upload').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadAvatar(e.target.files[0]);
            }
        });
    }

    // Show section
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.profile-section-block').forEach(section => {
            section.classList.remove('active');
        });
        
        // Remove active class from all dots
        document.querySelectorAll('.nav-dot').forEach(dot => {
            dot.classList.remove('active');
        });
        
        // Show selected section
        document.getElementById(sectionId).classList.add('active');
        
        // Add active class to corresponding dot
        document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
        
        currentSection = sectionId;
    }

    // Save profile
    function saveProfile() {
        const formData = new FormData();
        formData.append('action', 'update_profile');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        // Add form fields
        const fields = ['full_name', 'phone_number', 'date_of_birth', 'address', 'city', 'state', 'country', 'postal_code'];
        fields.forEach(field => {
            const value = document.getElementById(field).value;
            if (value) formData.append(field, value);
        });
        
        fetch('{% url "profile_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                if (data.completion) {
                    updateCompletionStatus(data.completion);
                }
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            showError('Failed to save profile: ' + error.message);
        });
    }

    // Save social links
    function saveSocial() {
        const formData = new FormData();
        formData.append('action', 'update_social');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        // Add social fields
        const fields = ['github', 'linkedin', 'facebook'];
        fields.forEach(field => {
            const value = document.getElementById(field).value;
            if (value) formData.append(field, value);
        });
        
        fetch('{% url "profile_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                if (data.completion) {
                    updateCompletionStatus(data.completion);
                }
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            showError('Failed to save social links: ' + error.message);
        });
    }

    // Save settings
    function saveSettings() {
        const formData = new FormData();
        formData.append('action', 'update_settings');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        formData.append('email_notifications', document.getElementById('email_notifications').checked);
        formData.append('push_notifications', document.getElementById('push_notifications').checked);
        formData.append('two_factor_auth', document.getElementById('two_factor_auth').checked);
        
        fetch('{% url "profile_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            showError('Failed to save settings: ' + error.message);
        });
    }

    // Change password
    function changePassword() {
        const currentPassword = document.getElementById('current_password').value;
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            showError('Please fill in all password fields');
            return;
        }
        
        const formData = new FormData();
        formData.append('action', 'change_password');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        formData.append('current_password', currentPassword);
        formData.append('new_password', newPassword);
        formData.append('confirm_password', confirmPassword);
        
        fetch('{% url "profile_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 2000);
                }
                // Clear form
                document.getElementById('password-form').reset();
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            showError('Failed to change password: ' + error.message);
        });
    }

    // Upload avatar
    function uploadAvatar(file) {
        const formData = new FormData();
        formData.append('action', 'upload_avatar');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        formData.append('avatar', file);
        
        fetch('{% url "profile_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                document.getElementById('profile-avatar-preview').src = data.avatar_url;
                if (data.completion) {
                    updateCompletionStatus(data.completion);
                }
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            showError('Failed to upload avatar: ' + error.message);
        });
    }

    // Delete account
    function deleteAccount() {
        const password = document.getElementById('delete_password').value;
        
        if (!password) {
            showError('Please enter your password to confirm account deletion');
            return;
        }
        
        if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
            return;
        }
        
        const formData = new FormData();
        formData.append('action', 'delete_account');
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        formData.append('password', password);
        
        fetch('{% url "profile_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 2000);
                }
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            showError('Failed to delete account: ' + error.message);
        });
    }

    // Show loading state
    function showLoading() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('profileContent').style.display = 'none';
    }

    // Hide loading state
    function hideLoading() {
        document.getElementById('loadingState').style.display = 'none';
    }

    // Show success message
    function showSuccess(message) {
        showMessage(message, 'success');
    }

    // Show error message
    function showError(message) {
        showMessage(message, 'error');
    }

    // Show message
    function showMessage(message, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;
        
        const container = document.querySelector('.profile-container');
        container.insertBefore(messageDiv, container.firstChild);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 5000);
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %} 